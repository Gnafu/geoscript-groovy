package geoscript.geom

import org.junit.Test
import static org.junit.Assert.*
import com.vividsolutions.jts.geom.Point as JtsPoint
import com.vividsolutions.jts.geom.Coordinate

/**
 * The Geometry unit test
 */
class GeometryTestCase {

    @Test void constructor() {
        JtsPoint pt = Geometry.factory.createPoint(new Coordinate(111,-47))
        Geometry g = new Geometry(pt)
        assertNotNull(g)
        assertEquals "POINT (111 -47)", g.toString()
    }
	
    @Test void buffer() {
        JtsPoint pt = Geometry.factory.createPoint(new Coordinate(111,-47))
        Geometry g = new Geometry(pt)
        Geometry p = g.buffer(5.0)
        assertNotNull(p)
        assertEquals pt.buffer(5.0).toString(), p.toString()
    }
	
    @Test void getWkt() {
        Geometry g = new Geometry(Geometry.factory.createPoint(new Coordinate(111,-47)))
        assertEquals "POINT (111 -47)", g.wkt
    }
	
    @Test void string() {
        Geometry g = new Geometry(Geometry.factory.createPoint(new Coordinate(111,-47)))
        assertEquals "POINT (111 -47)", g.toString()
    }
	
    @Test void wrap() {
        Geometry g = Geometry.wrap(Geometry.factory.createPoint(new Coordinate(111,-47)))
        assertEquals "POINT (111 -47)", g.toString()
    }
	
    @Test void fromWkt() {
        Geometry g = Geometry.fromWKT("POINT (111 -47)")
        assertEquals "POINT (111 -47)", g.toString()
    }

    @Test void getKml() {
        Geometry g = Geometry.fromWKT("POINT (111 -47)")
        assertEquals "<Point><coordinates>111.0,-47.0</coordinates></Point>", g.kml
    }

    @Test void fromKml() {
        Geometry g = Geometry.fromKml("<Point><coordinates>111.0,-47.0</coordinates></Point>")
        assertEquals "POINT (111 -47)", g.toString()
    }

    @Test void getGeoJSON() {
        Geometry g = Geometry.fromWKT("POINT (111 -47)")
        assertEquals """{ "type": "Point", "coordinates": [111.0, -47.0] }""", g.geoJSON
    }

    @Test void fromGeoJSON() {
        Geometry g = Geometry.fromGeoJSON("""{ "type": "Point", "coordinates": [111.0, -47.0] }""")
        assertEquals "POINT (111 -47)", g.toString()
    }

    @Test void getGml2() {
        Geometry g = Geometry.fromWKT("POINT (111 -47)")
        assertEquals "<gml:Point><gml:coordinates>111.0,-47.0</gml:coordinates></gml:Point>", g.gml2
    }

    @Test void fromGml2() {
        Geometry g = Geometry.fromGML2("<gml:Point><gml:coordinates>111.0,-47.0</gml:coordinates></gml:Point>")
        assertEquals "POINT (111 -47)", g.toString()
    }

    @Test void getGml3() {
        Geometry g = Geometry.fromWKT("POINT (111 -47)")
        assertEquals "<gml:Point><gml:pos>111.0 -47.0</gml:pos></gml:Point>", g.gml3
    }

    @Test void fromGml3() {
        Geometry g = Geometry.fromGML3("<gml:Point><gml:pos>111.0 -47.0</gml:pos></gml:Point>")
        assertEquals "POINT (111 -47)", g.toString()
    }

    @Test void getCoordinates() {
        Geometry g = Geometry.fromWKT("POINT (111 -47)")
        def coordinates = g.coordinates
        assertEquals 1, coordinates.length
        assertEquals(111, coordinates[0].x, 0.0)
        assertEquals(-47, coordinates[0].y, 0.0)
    }

    @Test void getMinimumBoundingCircle() {
        Geometry g = new GeometryCollection([
            new Point(-122.394276, 46.970863),
            new Point(-121.927567, 46.929644),
            new Point(-122.533838, 47.284403),
            new Point(-122.079196, 47.187141)
        ])
        Geometry circle = g.minimumBoundingCircle
        // println("Minimum Bounding Circle: ${circle}")
        assertNotNull(circle)
        assertTrue(circle instanceof Polygon)
    }

    @Test void getDelaunayTriangleDiagram() {
        Geometry g = new GeometryCollection([
            new Point(-122.394276, 46.970863),
            new Point(-121.927567, 46.929644),
            new Point(-122.533838, 47.284403),
            new Point(-122.079196, 47.187141)
        ])
        Geometry triangles = g.delaunayTriangleDiagram
        // println("Delaunay Triangles: ${triangles}")
        assertNotNull(triangles)
        assertTrue(triangles instanceof GeometryCollection)
    }

    @Test void getVoronoiDiagram() {
        Geometry g = new GeometryCollection([
            new Point(-122.394276, 46.970863),
            new Point(-121.927567, 46.929644),
            new Point(-122.533838, 47.284403),
            new Point(-122.079196, 47.187141)
        ])
        Geometry diagram = g.voronoiDiagram
        // println("Voronoi Diagram: ${diagram}")
        assertNotNull(diagram)
        assertTrue(diagram instanceof GeometryCollection)
    }

    @Test void getBounds() {
        Geometry g = new GeometryCollection([
            new Point(-122.394276, 46.970863),
            new Point(-121.927567, 46.929644),
            new Point(-122.533838, 47.284403),
            new Point(-122.079196, 47.187141)
        ])
        Bounds b = g.bounds
        assertEquals "(-122.533838,46.929644,-121.927567,47.284403)", b.toString()
    }

    @Test void simplify() {
        String wkt = """POLYGON ((13.63525390625 51.337890625, 13.59130859375 51.337890625, 13.41552734375 51.337890625, 12.44873046875 51.8212890625, 11.04248046875 52.5244140625, 9.98779296875 52.919921875, 8.53759765625 53.359375, 7.52685546875 53.53515625, 6.47216796875 53.6669921875, 5.63720703125 53.6669921875, 5.02197265625 53.6669921875, 4.67041015625 53.6669921875, 4.40673828125 53.4912109375, 4.14306640625 53.2275390625, 3.96728515625 52.919921875, 3.79150390625 52.568359375, 3.65966796875 52.1728515625, 3.52783203125 51.7333984375, 3.35205078125 51.25, 3.13232421875 50.72265625, 2.82470703125 49.931640625, 2.56103515625 49.2724609375, 2.29736328125 48.61328125, 2.07763671875 47.998046875, 1.90185546875 47.4267578125, 1.81396484375 46.8994140625, 1.77001953125 46.4599609375, 1.72607421875 46.1962890625, 1.72607421875 45.8447265625, 1.72607421875 45.6689453125, 1.72607421875 45.44921875, 1.72607421875 45.2734375, 1.72607421875 45.009765625, 1.85791015625 44.5263671875, 2.03369140625 44.21875, 2.25341796875 43.779296875, 2.51708984375 43.4716796875, 2.73681640625 43.2080078125, 3.00048828125 43.0322265625, 3.30810546875 42.9443359375, 3.96728515625 42.900390625, 4.05517578125 42.900390625, 4.31884765625 42.900390625, 4.75830078125 42.7685546875, 5.59326171875 42.5048828125, 6.47216796875 42.2412109375, 7.30712890625 41.93359375, 7.87841796875 41.8017578125, 8.58154296875 41.6259765625, 9.37255859375 41.494140625, 10.03173828125 41.40625, 10.64697265625 41.3623046875, 10.91064453125 41.3623046875, 11.13037109375 41.3623046875, 11.52587890625 41.3623046875, 12.18505859375 41.40625, 13.28369140625 41.7138671875, 14.33837890625 41.9775390625, 14.86572265625 42.197265625, 15.48095703125 42.548828125, 15.87646484375 42.7685546875, 16.18408203125 42.98828125, 16.40380859375 43.2080078125, 16.57958984375 43.427734375, 16.75537109375 43.69140625, 16.88720703125 44.04296875, 17.06298828125 44.482421875, 17.19482421875 45.009765625, 17.45849609375 46.064453125, 17.54638671875 46.328125, 17.63427734375 46.8115234375, 17.67822265625 47.0751953125, 17.67822265625 47.2509765625, 17.67822265625 47.3388671875, 17.63427734375 47.3388671875, 17.54638671875 47.3388671875, 17.28271484375 47.3388671875, 17.01904296875 47.3388671875, 16.62353515625 47.3388671875, 16.27197265625 47.3388671875, 15.87646484375 47.3388671875, 15.52490234375 47.3388671875, 15.21728515625 47.3388671875, 14.90966796875 47.294921875, 14.64599609375 47.2509765625, 14.38232421875 47.1630859375, 14.16259765625 47.1630859375, 13.89892578125 47.0751953125, 13.67919921875 47.03125, 13.45947265625 46.9873046875, 13.19580078125 46.9873046875, 12.97607421875 46.9873046875, 12.80029296875 46.9873046875, 12.58056640625 47.03125, 12.40478515625 47.1630859375, 12.22900390625 47.4267578125, 12.05322265625 47.6904296875, 12.00927734375 47.998046875, 11.96533203125 48.4375, 11.96533203125 48.701171875, 11.96533203125 48.9208984375, 12.00927734375 49.0966796875, 12.18505859375 49.2724609375, 12.36083984375 49.404296875, 12.58056640625 49.580078125, 12.75634765625 49.6240234375, 13.02001953125 49.7119140625, 13.28369140625 49.7119140625, 13.45947265625 49.7119140625, 13.76708984375 49.7119140625, 14.03076171875 49.66796875, 14.25048828125 49.580078125, 14.38232421875 49.4921875, 14.55810546875 49.4482421875, 14.68994140625 49.3603515625, 14.86572265625 49.3603515625, 14.99755859375 49.3603515625, 15.17333984375 49.3603515625, 15.39306640625 49.3603515625, 15.65673828125 49.3603515625, 15.83251953125 49.404296875, 16.00830078125 49.404296875, 16.31591796875 49.4921875, 16.44775390625 49.4921875, 16.57958984375 49.4921875, 16.71142578125 49.4921875, 16.79931640625 49.4921875, 16.88720703125 49.5361328125, 16.97509765625 49.5361328125, 17.01904296875 49.580078125, 17.10693359375 49.6240234375, 17.15087890625 49.66796875, 17.15087890625 49.7119140625, 17.19482421875 49.84375, 17.23876953125 50.01953125, 17.23876953125 50.2392578125, 17.23876953125 50.37109375, 17.28271484375 50.546875, 17.28271484375 50.634765625, 17.28271484375 50.72265625, 17.28271484375 50.7666015625, 17.28271484375 50.810546875, 17.28271484375 50.8544921875, 17.28271484375 50.8984375, 13.63525390625 51.337890625))"""
        Geometry g = Geometry.fromWKT(wkt)
        Geometry simplified = g.simplify(2)
        assertEquals "POLYGON ((13.63525390625 51.337890625, 17.28271484375 50.8984375, 11.96533203125 48.9208984375, 17.67822265625 47.3388671875, 15.87646484375 42.7685546875, 2.25341796875 43.779296875, 4.67041015625 53.6669921875, 13.63525390625 51.337890625))", simplified.wkt
    }

    @Test void simplifyPreservingTopology() {
        String wkt = """POLYGON ((13.63525390625 51.337890625, 13.59130859375 51.337890625, 13.41552734375 51.337890625, 12.44873046875 51.8212890625, 11.04248046875 52.5244140625, 9.98779296875 52.919921875, 8.53759765625 53.359375, 7.52685546875 53.53515625, 6.47216796875 53.6669921875, 5.63720703125 53.6669921875, 5.02197265625 53.6669921875, 4.67041015625 53.6669921875, 4.40673828125 53.4912109375, 4.14306640625 53.2275390625, 3.96728515625 52.919921875, 3.79150390625 52.568359375, 3.65966796875 52.1728515625, 3.52783203125 51.7333984375, 3.35205078125 51.25, 3.13232421875 50.72265625, 2.82470703125 49.931640625, 2.56103515625 49.2724609375, 2.29736328125 48.61328125, 2.07763671875 47.998046875, 1.90185546875 47.4267578125, 1.81396484375 46.8994140625, 1.77001953125 46.4599609375, 1.72607421875 46.1962890625, 1.72607421875 45.8447265625, 1.72607421875 45.6689453125, 1.72607421875 45.44921875, 1.72607421875 45.2734375, 1.72607421875 45.009765625, 1.85791015625 44.5263671875, 2.03369140625 44.21875, 2.25341796875 43.779296875, 2.51708984375 43.4716796875, 2.73681640625 43.2080078125, 3.00048828125 43.0322265625, 3.30810546875 42.9443359375, 3.96728515625 42.900390625, 4.05517578125 42.900390625, 4.31884765625 42.900390625, 4.75830078125 42.7685546875, 5.59326171875 42.5048828125, 6.47216796875 42.2412109375, 7.30712890625 41.93359375, 7.87841796875 41.8017578125, 8.58154296875 41.6259765625, 9.37255859375 41.494140625, 10.03173828125 41.40625, 10.64697265625 41.3623046875, 10.91064453125 41.3623046875, 11.13037109375 41.3623046875, 11.52587890625 41.3623046875, 12.18505859375 41.40625, 13.28369140625 41.7138671875, 14.33837890625 41.9775390625, 14.86572265625 42.197265625, 15.48095703125 42.548828125, 15.87646484375 42.7685546875, 16.18408203125 42.98828125, 16.40380859375 43.2080078125, 16.57958984375 43.427734375, 16.75537109375 43.69140625, 16.88720703125 44.04296875, 17.06298828125 44.482421875, 17.19482421875 45.009765625, 17.45849609375 46.064453125, 17.54638671875 46.328125, 17.63427734375 46.8115234375, 17.67822265625 47.0751953125, 17.67822265625 47.2509765625, 17.67822265625 47.3388671875, 17.63427734375 47.3388671875, 17.54638671875 47.3388671875, 17.28271484375 47.3388671875, 17.01904296875 47.3388671875, 16.62353515625 47.3388671875, 16.27197265625 47.3388671875, 15.87646484375 47.3388671875, 15.52490234375 47.3388671875, 15.21728515625 47.3388671875, 14.90966796875 47.294921875, 14.64599609375 47.2509765625, 14.38232421875 47.1630859375, 14.16259765625 47.1630859375, 13.89892578125 47.0751953125, 13.67919921875 47.03125, 13.45947265625 46.9873046875, 13.19580078125 46.9873046875, 12.97607421875 46.9873046875, 12.80029296875 46.9873046875, 12.58056640625 47.03125, 12.40478515625 47.1630859375, 12.22900390625 47.4267578125, 12.05322265625 47.6904296875, 12.00927734375 47.998046875, 11.96533203125 48.4375, 11.96533203125 48.701171875, 11.96533203125 48.9208984375, 12.00927734375 49.0966796875, 12.18505859375 49.2724609375, 12.36083984375 49.404296875, 12.58056640625 49.580078125, 12.75634765625 49.6240234375, 13.02001953125 49.7119140625, 13.28369140625 49.7119140625, 13.45947265625 49.7119140625, 13.76708984375 49.7119140625, 14.03076171875 49.66796875, 14.25048828125 49.580078125, 14.38232421875 49.4921875, 14.55810546875 49.4482421875, 14.68994140625 49.3603515625, 14.86572265625 49.3603515625, 14.99755859375 49.3603515625, 15.17333984375 49.3603515625, 15.39306640625 49.3603515625, 15.65673828125 49.3603515625, 15.83251953125 49.404296875, 16.00830078125 49.404296875, 16.31591796875 49.4921875, 16.44775390625 49.4921875, 16.57958984375 49.4921875, 16.71142578125 49.4921875, 16.79931640625 49.4921875, 16.88720703125 49.5361328125, 16.97509765625 49.5361328125, 17.01904296875 49.580078125, 17.10693359375 49.6240234375, 17.15087890625 49.66796875, 17.15087890625 49.7119140625, 17.19482421875 49.84375, 17.23876953125 50.01953125, 17.23876953125 50.2392578125, 17.23876953125 50.37109375, 17.28271484375 50.546875, 17.28271484375 50.634765625, 17.28271484375 50.72265625, 17.28271484375 50.7666015625, 17.28271484375 50.810546875, 17.28271484375 50.8544921875, 17.28271484375 50.8984375, 13.63525390625 51.337890625))"""
        Geometry g = Geometry.fromWKT(wkt)
        Geometry simplified = g.simplifyPreservingTopology(2)
        assertEquals "POLYGON ((13.63525390625 51.337890625, 4.67041015625 53.6669921875, 2.25341796875 43.779296875, 15.87646484375 42.7685546875, 17.67822265625 47.3388671875, 11.96533203125 48.9208984375, 17.28271484375 50.8984375, 13.63525390625 51.337890625))", simplified.wkt
    }
}